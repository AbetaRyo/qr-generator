<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ« ãƒã‚±ãƒƒãƒˆè³¼å…¥æ™‚ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.24/jsrsasign-all-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding-top: 40px; }
    input, button { margin: 8px; padding: 8px; font-size: 15px; }
    canvas { margin-top: 20px; }
    pre { background: #f9f9f9; padding: 10px; width: 90%; margin: auto; text-align: left; }
  </style>
</head>
<body>
  <h1>ğŸ« ãƒã‚±ãƒƒãƒˆè³¼å…¥æ™‚ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h1>
  <input type="text" id="user_id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"><br>
  <input type="text" id="ticket_source" placeholder="ãƒã‚±ãƒƒãƒˆã‚µã‚¤ãƒˆå"><br>
  <button onclick="generateQRCode()">QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
  <div id="qrcode"></div>
  <pre id="jwtDisplay"></pre>

  <script>
    async function generateQRCode() {
      const user_id = document.getElementById('user_id').value.trim();
      const ticket_source = document.getElementById('ticket_source').value.trim();
      if (!user_id || !ticket_source) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");

      const device_id = localStorage.getItem('device_id') || (() => {
        const id = crypto.randomUUID();
        localStorage.setItem('device_id', id);
        return id;
      })();

      const payload = {
        user_id,
        device_id,
        ticket_source,
        iat: KJUR.jws.IntDate.get('now'),
        exp: KJUR.jws.IntDate.get('now + 1hour')
      };
      const header = { alg: "HS256", typ: "JWT" };
      const secret = "your_super_secret_key";

      const jwt = KJUR.jws.JWS.sign(null, JSON.stringify(header), JSON.stringify(payload), secret);

      // âœ… ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      await fetch("http://localhost:3000/save-purchase", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ jwt })
      });

      // QRè¡¨ç¤º
      document.getElementById('jwtDisplay').textContent = jwt;
      const div = document.getElementById('qrcode');
      div.innerHTML = "";
      QRCode.toCanvas(jwt, { width: 300 }, (err, canvas) => div.appendChild(canvas));
    }
  </script>
</body>
</html>
