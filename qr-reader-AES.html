<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRã‚³ãƒ¼ãƒ‰å¾©å·ãƒ»èªè¨¼ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; cursor: pointer; }
    textarea { width: 90%; padding: 10px; font-size: 14px; margin: 10px auto; display: block; }
    pre { background: #f9f9f9; padding: 10px; white-space: pre-wrap; text-align: left; width: 90%; margin: 10px auto; border-radius: 8px; border: 1px solid #ccc; }
    .match { color: green; font-weight: bold; }
    .mismatch { color: red; font-weight: bold; }
    #reader { width: 300px; margin: 20px auto; }
  </style>
</head>
<body>

  <h1>ğŸ“· QRã‚³ãƒ¼ãƒ‰èªè¨¼ï¼ˆAESå¾©å·ï¼‹ç«¯æœ«ç…§åˆï¼‰</h1>

  <button onclick="startScan()">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
  <div id="reader"></div>

  <textarea id="jwt" rows="3" placeholder="QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚‰ã‚ŒãŸJWT"></textarea>

  <h3>ğŸ“„ JWT Payload</h3>
  <pre id="payload"></pre>

  <h3>ğŸ” èªè¨¼çµæœ</h3>
  <p id="result"></p>

  <script>
    // --- AESéµã‚’ç”Ÿæˆï¼ˆQRç™ºè¡Œå´ã¨åŒã˜éµç´ æã‚’ä½¿ç”¨ï¼‰ ---
    async function getAesKey() {
      const keyMaterial = new TextEncoder().encode("1234567890abcdef1234567890abcdef"); // 32æ–‡å­—ï¼256bit
      return crypto.subtle.importKey(
        "raw",
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    // --- Base64æ–‡å­—åˆ— â†’ Uint8Array ---
    function base64ToBytes(base64) {
      const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    // --- AES-GCMã§å¾©å· ---
    async function decryptAES(encryptedBase64, ivBase64, key) {
      const encryptedData = base64ToBytes(encryptedBase64);
      const iv = base64ToBytes(ivBase64);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, encryptedData);
      return new TextDecoder().decode(decrypted);
    }

    // --- JWTã®Payloadã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ ---
    function decodePayload(jwt) {
      const parts = jwt.split(".");
      if (parts.length !== 3) throw new Error("JWTå½¢å¼ãŒä¸æ­£ã§ã™");
      const payloadB64 = parts[1]
        .replace(/-/g, '+')
        .replace(/_/g, '/')
        .padEnd(parts[1].length + (4 - parts[1].length % 4) % 4, '=');
      const decoded = atob(payloadB64);
      return JSON.parse(decoded);
    }

    // --- QRèª­ã¿å–ã‚Šé–‹å§‹ ---
    function startScan() {
      const readerDiv = document.getElementById("reader");
      readerDiv.innerHTML = ""; // åˆæœŸåŒ–

      const html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          html5QrCode.stop();
          document.getElementById("jwt").value = decodedText;
          await verifyQRCode(decodedText);
        },
        (errorMessage) => { /* èª­ã¿å–ã‚Šå¤±æ•—ã¯ç„¡è¦– */ }
      );
    }

    // --- èªè¨¼å‡¦ç† ---
    async function verifyQRCode(jwt) {
      const resultEl = document.getElementById("result");
      try {
        const payload = decodePayload(jwt);
        document.getElementById("payload").textContent = JSON.stringify(payload, null, 2);

        const key = await getAesKey();
        const decryptedDeviceId = await decryptAES(payload.encrypted_device_id, payload.iv, key);

        if (payload.device_id === decryptedDeviceId) {
          resultEl.innerHTML = "<span class='match'>âœ… èªè¨¼æˆåŠŸï¼šåŒä¸€ç«¯æœ«ã‹ã‚‰ç™ºè¡Œã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã§ã™</span>";
        } else {
          resultEl.innerHTML = "<span class='mismatch'>âŒ èªè¨¼å¤±æ•—ï¼šç«¯æœ«æƒ…å ±ãŒä¸€è‡´ã—ã¾ã›ã‚“</span>";
        }

      } catch (e) {
        console.error("ã‚¨ãƒ©ãƒ¼:", e);
        alert("QRã‚³ãƒ¼ãƒ‰ã®è§£æãƒ»å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        resultEl.textContent = '';
      }
    }
  </script>
</body>
</html>
