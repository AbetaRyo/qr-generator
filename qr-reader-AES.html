<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ« JWTç…§åˆï¼ˆQRèª­ã¿å–ã‚Šï¼‹AESå¾©å·ï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.24/jsrsasign-all-min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button { padding: 10px 20px; font-size: 16px; margin: 10px; cursor: pointer; }
    pre { background: #f9f9f9; padding: 10px; white-space: pre-wrap; text-align: left; width: 90%; margin: 10px auto; border-radius: 8px; border: 1px solid #ccc; }
    #reader { width: 300px; margin: 20px auto; }
    .match { color: green; font-weight: bold; }
    .mismatch { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h1>ğŸ“· JWTèªè¨¼ï¼ˆAESå¾©å·ï¼‹QRèª­ã¿å–ã‚Šï¼‰</h1>

  <button onclick="startScan()">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
  <div id="reader"></div>

  <h3>ğŸ“¦ JWTï¼ˆæ–‡å­—åˆ—ï¼‰</h3>
  <pre id="jwtDisplay"></pre>

  <h3>ğŸ“„ Payload</h3>
  <pre id="payloadDisplay"></pre>

  <h3>ğŸ” èªè¨¼çµæœ</h3>
  <p id="result"></p>

  <script>
    // AESéµã‚’ç”Ÿæˆï¼ˆQRç”Ÿæˆå´ã¨åŒã˜éµã‚’ä½¿ã†ï¼‰
    async function getAesKey() {
      const keyMaterial = new TextEncoder().encode("1234567890abcdef1234567890abcdef");
      return crypto.subtle.importKey(
        "raw",
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    // AESå¾©å·å‡¦ç†ï¼ˆQRç”Ÿæˆå´ã¨å¯¾å¿œï¼‰
    async function decryptDeviceId(base64) {
      const key = await getAesKey();
      const data = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
      const iv = data.slice(0, 12);
      const cipher = data.slice(12);
      const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, cipher);
      return new TextDecoder().decode(plain);
    }

    // JWTãƒ‡ã‚³ãƒ¼ãƒ‰
    function decodePayload(jwt) {
      const parts = jwt.split(".");
      if (parts.length !== 3) throw new Error("JWTå½¢å¼ãŒä¸æ­£ã§ã™");
      const payloadB64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
      const padded = payloadB64.padEnd(payloadB64.length + (4 - payloadB64.length % 4) % 4, "=");
      const decoded = atob(padded);
      return JSON.parse(decoded);
    }

    // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šQRèª­ã¿å–ã‚Šé–‹å§‹
    function startScan() {
      const readerDiv = document.getElementById("reader");
      readerDiv.innerHTML = "";
      const html5QrCode = new Html5Qrcode("reader");

      const config = { fps: 10, qrbox: 250 };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          html5QrCode.stop();
          document.getElementById("jwtDisplay").textContent = decodedText;

          try {
            const payload = decodePayload(decodedText);
            document.getElementById("payloadDisplay").textContent =
              JSON.stringify(payload, null, 2);

            // AESå¾©å·ã—ã¦æ¯”è¼ƒ
            if (!payload.device_id_encrypted || !payload.event_nonce) {
              document.getElementById("result").innerHTML =
                "<span class='mismatch'>âŒ å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚</span>";
              return;
            }

            const decrypted_device_id = await decryptDeviceId(payload.device_id_encrypted);

            if (payload.device_id === decrypted_device_id) {
              document.getElementById("result").innerHTML =
                "<span class='match'>âœ… èªè¨¼æˆåŠŸï¼šåŒä¸€ç«¯æœ«ã®QRã‚³ãƒ¼ãƒ‰ã§ã™ï¼</span>";
            } else {
              document.getElementById("result").innerHTML =
                "<span class='mismatch'>âŒ èªè¨¼å¤±æ•—ï¼šç«¯æœ«æƒ…å ±ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚</span>";
            }

          } catch (e) {
            console.error("è§£æã‚¨ãƒ©ãƒ¼:", e);
            document.getElementById("result").innerHTML =
              "<span class='mismatch'>âŒ JWTã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚</span>";
          }
        },
        (error) => {
          // ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦OK
        }
      );
    }
  </script>

</body>
</html>
